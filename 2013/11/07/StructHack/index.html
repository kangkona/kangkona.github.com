<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Struct Hack | Gray Times</title>
  <meta name="author" content="Kangkona D.Han">
  
  <meta name="description" content="最近在搞Compiler的CodeGenerator实验，有一部分需要把Java程序翻译成C程序，比如:
123int [] array;array = new int[10];System.out.println(array.length); //10">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Struct Hack"/>
  <meta property="og:site_name" content="Gray Times"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="Gray Times" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Gray Times</a></h1>
  <h2><a href="/">Record the history that you never forget.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-06T23:56:29.000Z"><a href="/2013/11/07/StructHack/">11月 7 2013</a></time>
      
      
  
    <h1 class="title">Struct Hack</h1>
  

    </header>
    <div class="entry">
      
        <p>最近在搞<strong>Compiler</strong>的<strong>CodeGenerator</strong>实验，有一部分需要把Java程序翻译成C程序，比如:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> [] <span class="built_in">array</span>;</div><div class="line"><span class="built_in">array</span> = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</div><div class="line">System.out.println(<span class="built_in">array</span>.length); <span class="comment">//10</span></div></pre></td></tr></table></figure>

<a id="more"></a>

<p>这段代码翻译成C很自然的想法是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="type">int</span> * <span class="type">array</span>; // <span class="type">int</span> <span class="type">array</span>[] <span class="keyword">not</span> support <span class="keyword">in</span> C</div><div class="line"><span class="type">array</span> = (<span class="type">int</span>*)malloc(sizof(<span class="type">int</span>)*<span class="number">10</span>);</div><div class="line">printf(<span class="string">"%d\n"</span>,sizof(<span class="type">array</span>)/sizeof(<span class="type">int</span>)); // <span class="number">1</span></div></pre></td></tr></table></figure>

<p>但很可惜这样是错误的，因为malloc操作在堆上分配空间，不一定是连续的，sizof(array)得到的是指针本身所占的单元，和sizeof(int)相等，无法通过sizof求得数组长度。它和下面还不一样：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">10</span>];</div><div class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>,sizof(<span class="built_in">array</span>)/<span class="keyword">sizeof</span>(<span class="keyword">int</span>)); <span class="comment">// 10</span></div></pre></td></tr></table></figure>

<p>这里<code>array</code>是数组，是指向整个连续存储空间的常量，所以<code>sizeof</code>对其操作求得的是整个区域的长度。但是当数组名作为函数的参数传递时，数组就退化为指针，又回到了刚才问题。</p>
<p>我们应该怎么做？</p>
<p>在 <a href="http://stackoverflow.com/" target="_blank" rel="external">StackOverflow</a> 搜了一下，发现<code>ANSI C</code>根本没有直接办法通过指向内存的指针求得分配长度。但<code>Windows</code>下提供了计算指针指向的内存大小的方法[<a href="http://msdn.microsoft.com/zh-cn/library/vstudio/z2s077bc(v=vs.80).aspx#feedback" target="_blank" rel="external">malloc.h</a>]：</p>
<blockquote>
<p>msize: returns the size (in bytes) as an unsigned integer.</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">size_t _msize(</div><div class="line"><span class="keyword">void</span> *memblock</div><div class="line">);</div></pre></td></tr></table></figure>

<p>但由于操作系统策略的原因，实际分配到的大小可能会比指定的大一些<a href="http://jiaqinxu.info/tag/_msize" target="_blank" rel="external">here</a>。</p>
<p>在Linux下，指针往前偏移一个整形大小的单元也会记录实际分配的大小，我们来窥探一下那个单元的内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//test.c</span></div><div class="line"><span class="keyword">int</span> main(){</div><div class="line"> <span class="keyword">int</span> * p;</div><div class="line"> <span class="keyword">int</span> i;</div><div class="line"> <span class="keyword">int</span> size;</div><div class="line"> <span class="keyword">for</span> (i=<span class="number">1</span>;i&lt;<span class="number">11</span>;i++)</div><div class="line"> <span class="built_in">printf</span>(<span class="string">"%d "</span>,i);</div><div class="line"> <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line"> <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++){</div><div class="line"> p = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)*i);</div><div class="line"> size = *(<span class="keyword">int</span>*)((<span class="keyword">char</span>*)p-<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</div><div class="line"> <span class="built_in">printf</span>(<span class="string">"size:%d "</span>,size);</div><div class="line"> <span class="built_in">free</span>(p);</div><div class="line"> }</div><div class="line"> <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$gcc</span> test.c</div><div class="line"><span class="variable">$.</span>/a.out</div><div class="line"><span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  <span class="number">10</span></div><div class="line"><span class="number">17</span> <span class="number">17</span> <span class="number">17</span> <span class="number">17</span> <span class="number">25</span> <span class="number">25</span> <span class="number">33</span> <span class="number">33</span> <span class="number">41</span> <span class="number">41</span></div></pre></td></tr></table></figure>

<p>看来Linux的分配策略不能使得内存大小和元素个数一一对应，此法不可用。<br>后来发现在Linux下原来也有类似<code>_msize</code>的函数[<a href="http://www.linuxidc.com/Linux/2011-12/48624.htm" target="_blank" rel="external">malloc.h</a>]：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> * <span class="built_in">array</span>;</div><div class="line"><span class="keyword">int</span> size;</div><div class="line"><span class="built_in">array</span> = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(sizof(<span class="number">50</span>);</div><div class="line">size = malloc_usable_size(<span class="built_in">array</span>);</div><div class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>,size);<span class="comment">//50</span></div></pre></td></tr></table></figure>

<p>但是malloc.h不属于标准C，我们还要继续寻找通用之法。经过大量查阅，终于发现了一种code trick,称作<a href="http://tonybai.com/2013/03/07/struct-hack-in-c/" target="_blank" rel="external"><strong>struct-hack</strong></a>. 前面提到过，在C语言中，<code>int a[]</code>是违法的，但是把它作为struct的最后一个成员却是可以的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="built_in">array</span>{</div><div class="line"> <span class="keyword">int</span> size;</div><div class="line"> <span class="keyword">int</span> <span class="built_in">free</span>;</div><div class="line"> <span class="keyword">int</span> buf[];</div><div class="line"> }<span class="built_in">array</span>,*Tiger_array;</div></pre></td></tr></table></figure>

<p>这是在C语言的后期加入的特性，目的就是为了实现<strong>flexible array</strong>， 这样每次给数组分配空间时，需要同步记录size大小。而求size的时候，直接取出来即可：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Tiger_array <span class="keyword">ta</span>;</div><div class="line"><span class="keyword">ta</span> = (<span class="keyword">int</span>*)malloc(sizeof(array)+<span class="number">100</span>);</div><div class="line"><span class="keyword">ta</span>-&gt;size = <span class="number">100</span>;</div><div class="line"><span class="keyword">ta</span>-&gt;free = <span class="number">0</span>;</div></pre></td></tr></table></figure>

<p>需要注意一点，这时分配的大小应该是sizeof(struct)加上需求的数组大小。</p>
<p>这个问题就说到这里。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/C/">C</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/C/">C</a>, <a href="/tags/struct/">struct</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


 <nav id="pagination" >
    
    <a href="/2014/02/06/nlpNote/" class="alignleft prev" >上一页</a>
    
    
    <a href="/2013/03/16/pythonNote1/" class="alignright next" >下一页</a>
    
    <div class="clearfix"></div>
</nav>
<section id="comment">
<!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2013/11/07/StructHack/" data-title="Struct Hack" data-url="http://yoursite.com/2013/11/07/StructHack/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"kangkona"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/C/">C</a><small>1</small></li>
  
    <li><a href="/categories/FP/">FP</a><small>1</small></li>
  
    <li><a href="/categories/JavaEE/">JavaEE</a><small>1</small></li>
  
    <li><a href="/categories/Summary/">Summary</a><small>1</small></li>
  
    <li><a href="/categories/Web前端/">Web前端</a><small>1</small></li>
  
    <li><a href="/categories/nlp/">nlp</a><small>1</small></li>
  
    <li><a href="/categories/python/">python</a><small>1</small></li>
  
    <li><a href="/categories/reading/">reading</a><small>1</small></li>
  
    <li><a href="/categories/reflect/">reflect</a><small>1</small></li>
  
    <li><a href="/categories/storm/">storm</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/C/" style="font-size: 10.00px;">C</a><a href="/tags/NLP/" style="font-size: 10.00px;">NLP</a><a href="/tags/frontend,-caching,-web/" style="font-size: 10.00px;">frontend, caching, web</a><a href="/tags/javaee/" style="font-size: 10.00px;">javaee</a><a href="/tags/job/" style="font-size: 10.00px;">job</a><a href="/tags/muse/" style="font-size: 10.00px;">muse</a><a href="/tags/note/" style="font-size: 10.00px;">note</a><a href="/tags/pattern,-fp/" style="font-size: 10.00px;">pattern, fp</a><a href="/tags/project/" style="font-size: 10.00px;">project</a><a href="/tags/python/" style="font-size: 10.00px;">python</a><a href="/tags/reading/" style="font-size: 20.00px;">reading</a><a href="/tags/reflect,-blog/" style="font-size: 10.00px;">reflect, blog</a><a href="/tags/storm,-job/" style="font-size: 10.00px;">storm, job</a><a href="/tags/struct/" style="font-size: 10.00px;">struct</a><a href="/tags/summary/" style="font-size: 10.00px;">summary</a><a href="/tags/tomcat/" style="font-size: 10.00px;">tomcat</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">粉转路人由</h3>
<ul class="entry">
<li><a href="http://letiantian.me" title="樂天笔记~ | 享受生活&&技术&&编程">樂天好男人</a></li>
<li><a href="http://www.urbem.org" title="西城">西城冷风吹</a></li>
<li><a href="http://huangtuzhi.github.io" title="莹莹青碧">逍遥黄岛主</a></li>
<li><a href="http://ccloveyou.org" title="Love life & love tech">浪中云CC</a></li>
<li><a href="http://sinb.github.io" title="Amnesia's blog" >是小司不是小四</a></li>
</ul>
</div>

  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=9&isTitle=0&noborder=0&isWeibo=1&isFans=0&uid=1706116915&verifier=f6d88333&dpc=1"></iframe>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 Kangkona D.Han
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>

<a href="https://github.com/kangkona"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/121cd7cbdc3e4855075ea8b558508b91ac463ac2/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png"></a>