<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>八一八浏览器缓存 | Gray Times</title>
  <meta name="author" content="Kangkona D.Han">
  
  <meta name="description" content="今天由于需求变更，修改了部分前端代码，测试没问题之后进行了部署。交付测试时，发现修改的代码不起作用。而且比较奇怪的是一般手机浏览器没有问题，但微信内嵌浏览器内的结果还停留在部署之前的状态。分析后得知应该是缓存机制引起的。这里总结一下关于浏览器缓存的知识。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="八一八浏览器缓存"/>
  <meta property="og:site_name" content="Gray Times"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="Gray Times" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Gray Times</a></h1>
  <h2><a href="/">Record the history that you never forget.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-09-10T14:41:41.000Z"><a href="/2014/09/10/818-browser-caching/">9月 10 2014</a></time>
      
      
  
    <h1 class="title">八一八浏览器缓存</h1>
  

    </header>
    <div class="entry">
      
        <p>今天由于需求变更，修改了部分前端代码，测试没问题之后进行了部署。交付测试时，发现修改的代码不起作用。而且比较奇怪的是一般手机浏览器没有问题，但微信内嵌浏览器内的结果还停留在部署之前的状态。分析后得知应该是缓存机制引起的。这里总结一下关于浏览器缓存的知识。<br><a id="more"></a></p>
<h2 id="1-_为什么需要浏览器缓存">1. 为什么需要浏览器缓存</h2>
<p>  网络的带宽总是有限的，尤其是在并发比较高的情况下，能节约一点儿是一点儿。对于大多数网站来说，类似js, css，图片等静态文件是很少变化的。我们便可以在用户的一次请求之后在本地缓存静态文件。用户进行同样的请求(url一致)时，相应文件直接在本地读取，快速获得响应。 除了减少服务器压力和带宽外，缓存机制还可以极大提高页面的显示速度。</p>
<h2 id="2-_缓存协商">2.  缓存协商</h2>
<p>缓存的文件是由服务器生成，在本地保存， 但不是保存下来就万事大吉， 合理使用缓存需要双方动态沟通，这样就引入了缓存协商。下面是具体的请求过程分析：</p>
<pre><code>   (<span class="number">1</span>) 当浏览器第一次请求某个<span class="keyword">URL</span>时，顺利访问的话，服务器返回状态<span class="number">200</span>的状态, ; 同时会返回给浏览器一些Headers集合，
    如果只设定了<span class="keyword">Last</span>-Modified和Etag头信息，那么浏览器接收到服务器这些信息后，就会将资源缓存在本地目录中,同时
    保存文件的上述信息.
   (<span class="number">2</span>) 再次请求时，根据 HTTP 协议的规定，浏览器会向服务器传送 <span class="keyword">If</span>-Modified-Since 与 <span class="keyword">If</span>-<span class="keyword">None</span>-Match 报头，这
    两个报头实际上是第一次请求时服务器返回的<span class="keyword">Last</span>-Modified,Etag。发送这两个报头目地是询问服务器，该资源在
    时间内有没有被修改过。如 果该资源未被修改，则服务器会直接返回HTTP <span class="number">304</span> （<span class="keyword">Not</span> Changed.）状态码，内容为
    空，此时不会下载资源，浏览器则自动从缓存目录中读取资源。
   (<span class="number">3</span>) 只使用<span class="keyword">Last</span>-Modified和Etag 可以减少传输成本，但不会减少http请求数量。如果给文件加上关于过期时间(Expires)
    的header报文,这样浏览器就会先检查缓存中的文件，如果没有过期，就直接使用缓存中的文件,从而不会 发送http请求。 
</code></pre><h2 id="3-_缓存存在的问题">3. 缓存存在的问题</h2>
<pre><code>   既然存在了本地，那么最大的问题就是一旦服务器的文件更新了，而浏览器还在使用本地的缓存，
   会造成服务器端的修改不能生效。 我们碰到的问题刚好可以对号入座。
</code></pre><h2 id="4-_解决之道">4. 解决之道</h2>
<h3 id="4-1_设置html的缓存相关信息">4.1  设置html的缓存相关信息</h3>
<p>在html的头部加入如下信息:</p>
<pre><code>         &lt;META <span class="variable">HTTP-EQUIV=</span><span class="string">"pragma"</span> <span class="variable">CONTENT=</span><span class="string">"no-cache"</span>&gt; 

        &lt;META <span class="variable">HTTP-EQUIV=</span><span class="string">"Cache-Control"</span> <span class="variable">CONTENT=</span><span class="string">"no-cache, must-revalidate"</span>&gt; 

        &lt;META <span class="variable">HTTP-EQUIV=</span><span class="string">"expires"</span> <span class="variable">CONTENT=</span><span class="string">"0"</span>&gt; 
</code></pre><p>如果是动态语言生成的页面可以类似设置：</p>
<pre><code>        <span class="vbscript">&lt;% 
        // 将过期日期设置为一个过去时间 
        <span class="built_in">response</span>.setHeader(<span class="string">"Expires"</span>, <span class="string">"Sat, 6 May 1995 12:00:00 GMT"</span>); 
        // 设置 HTTP/<span class="number">1.1</span> no-cache 头 
        <span class="built_in">response</span>.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-store,no-cache,must-revalidate"</span>); 
        // 设置 IE 扩展 HTTP/<span class="number">1.1</span> no-cache headers， 用户自己添加 
        <span class="built_in">response</span>.addHeader(<span class="string">"Cache-Control"</span>, <span class="string">"post-check=0, pre-check=0"</span>); 
        // 设置标准 HTTP/<span class="number">1.0</span> no-cache header. 
        <span class="built_in">response</span>.setHeader(<span class="string">"Pragma"</span>, <span class="string">"no-cache"</span>); 
        %&gt;</span> 
</code></pre><h3 id="4-2_使用POST代替GET">4.2 使用POST代替GET</h3>
<p>根据 HTTP 规范，GET 用于信息获取，是幂等操作。也就是说，当使用相同的URL重复GET请求会返回预期的相同结果时，GET方法才是适用的。当对一个请求有副作用的时候（例如，提交数据注册新用户时），应该使用POST请求而不是GET。 所以浏览器会对GET请求做缓存处理。 不会对POST做缓存。</p>
<h3 id="4-3_在url后加随机参数">4.3 在url后加随机参数</h3>
<p>在一次请求的URL后加随机数，服务器就会认为是不同的请求，就会传回最新的文件覆盖旧的文件。但这种方法仅限于动态语言。</p>
<pre><code>    &lt;%@ page import=<span class="string">"java.util.Random"</span>%&gt;
    &lt;html&gt;    
    &lt;head&gt;
        &lt;script src=<span class="string">"js/fuck.js?&lt;%=new Random().nextInt(1000);%&gt;"</span>&gt;&lt;/script&gt;
    &lt;/head&gt;
    <span class="keyword">...</span>
    &lt;/html&gt;
</code></pre><h3 id="4-4_给修改后的文件换个名字">4.4  给修改后的文件换个名字</h3>
<p>上面的三种方法都是完全舍弃缓存优点的做法，如果既想使修改生效，又想继续使用缓存机制应该怎么办呢？  其实最简单的做法就是将修改过的文件换个名称，比如加个时间戳之类的东西。这是的文件就变成了新鲜出炉的文件，本地压根儿就没有，只得乖乖从服务器端获取。<br>这种方法理论上是行的通的，有时间我会试试，可惜我没有时间了。 你有时间不妨一试？</p>
<p>参考:<br><a href="http://alicsd.iteye.com/blog/814276" target="_blank" rel="external">浅谈浏览器缓存</a><br><a href="http://java-xp.iteye.com/blog/1518510" target="_blank" rel="external">浏览器缓存url请求</a><br><a href="http://www.360doc.com/content/10/0826/18/2905268_48986231.shtml" target="_blank" rel="external">浏览器缓存</a><br><a href="http://baike.baidu.com/view/1246381.htm?fr=aladdin" target="_blank" rel="external">百科</a></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web前端/">Web前端</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/frontend,-caching,-web/">frontend, caching, web</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


 <nav id="pagination" >
    
    <a href="/2014/09/13/the-story-of-aaron-swartz/" class="alignleft prev" >上一页</a>
    
    
    <a href="/2014/09/07/the-meaning-of-blogging/" class="alignright next" >下一页</a>
    
    <div class="clearfix"></div>
</nav>
<section id="comment">
<!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2014/09/10/818-browser-caching/" data-title="八一八浏览器缓存" data-url="http://yoursite.com/2014/09/10/818-browser-caching/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"kangkona"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/C/">C</a><small>1</small></li>
  
    <li><a href="/categories/Design/">Design</a><small>1</small></li>
  
    <li><a href="/categories/Experience/">Experience</a><small>1</small></li>
  
    <li><a href="/categories/FP/">FP</a><small>1</small></li>
  
    <li><a href="/categories/JavaEE/">JavaEE</a><small>1</small></li>
  
    <li><a href="/categories/Summary/">Summary</a><small>2</small></li>
  
    <li><a href="/categories/Web前端/">Web前端</a><small>1</small></li>
  
    <li><a href="/categories/movie/">movie</a><small>1</small></li>
  
    <li><a href="/categories/nlp/">nlp</a><small>1</small></li>
  
    <li><a href="/categories/python/">python</a><small>1</small></li>
  
    <li><a href="/categories/reading/">reading</a><small>1</small></li>
  
    <li><a href="/categories/reflect/">reflect</a><small>1</small></li>
  
    <li><a href="/categories/storm/">storm</a><small>2</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/C/" style="font-size: 10.00px;">C</a><a href="/tags/NLP/" style="font-size: 10.00px;">NLP</a><a href="/tags/design/" style="font-size: 10.00px;">design</a><a href="/tags/frontend,-caching,-web/" style="font-size: 10.00px;">frontend, caching, web</a><a href="/tags/javaee/" style="font-size: 10.00px;">javaee</a><a href="/tags/job/" style="font-size: 20.00px;">job</a><a href="/tags/movie/" style="font-size: 10.00px;">movie</a><a href="/tags/muse/" style="font-size: 10.00px;">muse</a><a href="/tags/note/" style="font-size: 10.00px;">note</a><a href="/tags/pattern,-fp/" style="font-size: 10.00px;">pattern, fp</a><a href="/tags/project/" style="font-size: 10.00px;">project</a><a href="/tags/python/" style="font-size: 10.00px;">python</a><a href="/tags/reading/" style="font-size: 20.00px;">reading</a><a href="/tags/reflect,-blog/" style="font-size: 10.00px;">reflect, blog</a><a href="/tags/storm,-job/" style="font-size: 20.00px;">storm, job</a><a href="/tags/struct/" style="font-size: 10.00px;">struct</a><a href="/tags/summary/" style="font-size: 20.00px;">summary</a><a href="/tags/tomcat/" style="font-size: 10.00px;">tomcat</a><a href="/tags/用户体验,-Sort,-Search/" style="font-size: 10.00px;">用户体验, Sort, Search</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">粉转路人由</h3>
<ul class="entry">
<li><a href="http://letiantian.me" title="樂天笔记~ | 享受生活&&技术&&编程">樂天好男人</a></li>
<li><a href="http://www.urbem.org" title="西城">西城冷风吹</a></li>
<li><a href="http://huangtuzhi.github.io" title="莹莹青碧">逍遥黄岛主</a></li>
<li><a href="http://ccloveyou.org" title="Love life & love tech">浪中云CC</a></li>
<li><a href="http://sinb.github.io" title="Amnesia's blog" >是小司不是小四</a></li>
</ul>
</div>

  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=9&isTitle=0&noborder=0&isWeibo=1&isFans=0&uid=1706116915&verifier=f6d88333&dpc=1"></iframe>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 Kangkona D.Han
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>

<a href="https://github.com/kangkona"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/121cd7cbdc3e4855075ea8b558508b91ac463ac2/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png"></a>