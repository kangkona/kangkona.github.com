<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Go实践之并发初体验 | Gray Times</title>
  <meta name="author" content="Kangkona D.Han">
  
  <meta name="description" content="golang的一大卖点是并发模型基于CPS(continuation passing style)，使用起来比较简单。刚开始我也觉得比较简单，但使用之后发现，你必须很清楚golang的并发机制才能使用自如，在需要同步尤甚，一不小心就会陷入罪恶的渊薮。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Go实践之并发初体验"/>
  <meta property="og:site_name" content="Gray Times"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="Gray Times" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Gray Times</a></h1>
  <h2><a href="/">Record the history that you never forget.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-11-28T02:56:08.000Z"><a href="/2014/11/28/concurrent-in-go/">11月 28 2014</a></time>
      
      
  
    <h1 class="title">Go实践之并发初体验</h1>
  

    </header>
    <div class="entry">
      
        <p>golang的一大卖点是并发模型基于CPS(continuation passing style)，使用起来比较简单。刚开始我也觉得比较简单，但使用之后发现，你必须很清楚golang的并发机制才能使用自如，在需要同步尤甚，一不小心就会陷入罪恶的渊薮。<br> <a id="more"></a></p>
<h2 id="Sharing_VS_Communicating">Sharing VS Communicating</h2>
<p>如何我们想从1顺序打印到10000，可能会<a href="http://play.golang.org/p/ZG5EihF4PU" target="_blank" rel="external">这样</a>写：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> messages <span class="keyword">chan</span> <span class="typename">int</span></div><div class="line"><span class="keyword">var</span> done <span class="keyword">chan</span> <span class="typename">bool</span></div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">	messages = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="typename">int</span>)</div><div class="line">	done = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="typename">bool</span>)</div><div class="line">	times :=<span class="number"> 10000</span></div><div class="line">	<span class="keyword">for</span> i :=<span class="number"> 0</span>; i &lt; times; i++ {</div><div class="line">		<span class="keyword">go</span> <span class="keyword">func</span>() {</div><div class="line">			messages &lt;- i</div><div class="line">			done &lt;- <span class="constant">true</span></div><div class="line">		}()</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="keyword">func</span>() {</div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> messages {</div><div class="line">			fmt.Println(i)</div><div class="line">		}</div><div class="line">	}()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i :=<span class="number"> 0</span>; i &lt; times; i++ {</div><div class="line">		&lt;-done</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>但事实上，打印的结果的是</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">10000</span></div><div class="line"><span class="number">10000</span></div><div class="line">....</div></pre></td></tr></table></figure>

<p>由于10000个for循环执行地相当快， 很可能在for已经循环结束， i的值增长到10000时， gorountines的调度才完成，i此时作为逃逸变量为goroutines共享，所以gorountines看到的i都是10000,打印的也都是10000。</p>
<p>以上共享变量的方式我们称之为Share，要解决这个问题，只能把main的i通过消息传递的方式Communicate给每个gorountines <a href="http://play.golang.org/p/lppU7mFsRh" target="_blank" rel="external">例子</a>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; times; i++ {</div><div class="line">	go <span class="func"><span class="keyword">func</span><span class="params">(v int)</span></span> {</div><div class="line">		messages &lt;- v</div><div class="line">		done &lt;- <span class="built_in">true</span></div><div class="line">	}(i)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>运行一下，结果是正确的。这时候才真正体会到那句话的奥妙：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Don’t communicate <span class="keyword">by</span> <span class="keyword">shared</span> memory. Instead, share memory <span class="keyword">by</span> communicating. </div><div class="line"></div><div class="line">	                                                                             —— Rob Pike</div></pre></td></tr></table></figure>

<h2 id="Synchronization">Synchronization</h2>
<p>golang没有join，无法直接在程序中设置等待点。实现同步通常有两种做法：</p>
<h3 id="使用channel">使用channel</h3>
<p>由于channel分为阻塞和非阻塞的，使用阻塞的channel时就能达到同步的目的。上面两个例子都使用了channel进行同步。</p>
<h3 id="使用WaitGroup">使用WaitGroup</h3>
<p><a href="http://play.golang.org/p/k440dqN3Ai" target="_blank" rel="external">示例如下</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">func main() {</div><div class="line">	var wg sync.WaitGroup</div><div class="line">	wg.Add(1000)</div><div class="line"></div><div class="line">	for i := 0; i &lt; 1000; i++ {</div><div class="line">		go func(v int) {</div><div class="line">			defer wg.Done()</div><div class="line">			fmt.Println(v)</div><div class="line">		}(i)</div><div class="line">	}</div><div class="line">	wg.Wait()</div><div class="line">	fmt.Println(<span class="string">"exit"</span>)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Add操作设置要等待的gorountine个数，每执行一次Done，waitgroup就会减1, 执行Wait的地方就相当于join。</p>
<p>两种操作的本质都是设置一个计数器，每个gorountine执行完都会通知一下主程序，直到所以gorountine完全dead，main才会往下走。</p>
<p>当不清楚gorountines的数目时，在<a href="http://segmentfault.com/q/1010000000487990" target="_blank" rel="external">网上</a>看到的一种做法是可以设置一个远大于gorountines的数目的<a href="http://play.golang.org/p/jb1wJaQJZ0" target="_blank" rel="external">阈值</a>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">L: <span class="keyword">for</span> { </div><div class="line">           select { </div><div class="line">               <span class="keyword">case</span> &lt;- <span class="keyword">done</span>:</div><div class="line">                   i++ </div><div class="line">                   <span class="keyword">if</span> i &gt; <span class="number">10000</span> {</div><div class="line">                         <span class="keyword">break</span> L</div><div class="line">                            }</div><div class="line">                   }</div><div class="line">            }</div></pre></td></tr></table></figure>

<h2 id="Concurrent_Data_Structure">Concurrent Data Structure</h2>
<p>在并发环境下，数据结构往往也需要设计成并发的，比如一个并发的Map可以这样设计：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">type <span class="type">CorrMap</span> <span class="class"><span class="keyword">struct</span> </span>{</div><div class="line">	line2BusId  <span class="built_in">map</span>[string][]string</div><div class="line">	sync.<span class="type">RWMutex</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="func"><span class="keyword">func</span></span> <span class="type">NewCorrMap</span>() *<span class="type">CorrMap</span> {</div><div class="line">	<span class="keyword">return</span> &<span class="type">CorrMap</span>{line2BusId :  <span class="built_in">map</span>[string][]string{}}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="func"><span class="keyword">func</span></span> (<span class="built_in">c</span> *<span class="type">CorrMap</span>) <span class="type">Add</span>(line string, busId string) {</div><div class="line">	<span class="built_in">c</span>.<span class="type">Lock</span>()</div><div class="line">	defer <span class="built_in">c</span>.<span class="type">Unlock</span>()</div><div class="line">	busIds, exists := <span class="built_in">c</span>.line2BusId[line]</div><div class="line">	<span class="keyword">if</span> exists {</div><div class="line">		<span class="built_in">c</span>.line2BusId[line] = append(busIds, busId)</div><div class="line">	} <span class="keyword">else</span> {</div><div class="line">		<span class="keyword">var</span> tmp []string</div><div class="line">		<span class="built_in">c</span>.line2BusId[line] = append(tmp, busId)</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="func"><span class="keyword">func</span></span> (<span class="built_in">c</span> <span class="type">CorrMap</span>) <span class="type">Size</span>() int {</div><div class="line">	<span class="built_in">count</span> := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> <span class="number">_</span>, v := range <span class="built_in">c</span>.line2BusId {</div><div class="line">		<span class="built_in">count</span>+= len(v)</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="built_in">count</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>不过利用Lock可能没有充分发挥golang的优势，更好的方法可以参考<a href="http://se77en.cc/2014/04/08/share-by-communicating-the-concurrency-slogan-in-golang/" target="_blank" rel="external">这篇博客</a>。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/golang/">golang</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/concurrent,-golang/">concurrent, golang</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


 <nav id="pagination" >
    
    
    <a href="/2014/11/28/json-and-go/" class="alignright next" >下一页</a>
    
    <div class="clearfix"></div>
</nav>
<section id="comment">
<!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2014/11/28/concurrent-in-go/" data-title="Go实践之并发初体验" data-url="http://yoursite.com/2014/11/28/concurrent-in-go/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"kangkona"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/C/">C</a><small>1</small></li>
  
    <li><a href="/categories/Design/">Design</a><small>1</small></li>
  
    <li><a href="/categories/Experience/">Experience</a><small>1</small></li>
  
    <li><a href="/categories/FP/">FP</a><small>1</small></li>
  
    <li><a href="/categories/JavaEE/">JavaEE</a><small>1</small></li>
  
    <li><a href="/categories/Summary/">Summary</a><small>2</small></li>
  
    <li><a href="/categories/Web前端/">Web前端</a><small>1</small></li>
  
    <li><a href="/categories/golang/">golang</a><small>2</small></li>
  
    <li><a href="/categories/movie/">movie</a><small>1</small></li>
  
    <li><a href="/categories/nlp/">nlp</a><small>1</small></li>
  
    <li><a href="/categories/python/">python</a><small>1</small></li>
  
    <li><a href="/categories/reading/">reading</a><small>1</small></li>
  
    <li><a href="/categories/reflect/">reflect</a><small>1</small></li>
  
    <li><a href="/categories/storm/">storm</a><small>2</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/C/" style="font-size: 10.00px;">C</a><a href="/tags/NLP/" style="font-size: 10.00px;">NLP</a><a href="/tags/concurrent,-golang/" style="font-size: 10.00px;">concurrent, golang</a><a href="/tags/design/" style="font-size: 10.00px;">design</a><a href="/tags/frontend,-caching,-web/" style="font-size: 10.00px;">frontend, caching, web</a><a href="/tags/javaee/" style="font-size: 10.00px;">javaee</a><a href="/tags/job/" style="font-size: 20.00px;">job</a><a href="/tags/json,-golang,-networking/" style="font-size: 10.00px;">json, golang, networking</a><a href="/tags/movie/" style="font-size: 10.00px;">movie</a><a href="/tags/muse/" style="font-size: 10.00px;">muse</a><a href="/tags/note/" style="font-size: 10.00px;">note</a><a href="/tags/pattern,-fp/" style="font-size: 10.00px;">pattern, fp</a><a href="/tags/project/" style="font-size: 10.00px;">project</a><a href="/tags/python/" style="font-size: 10.00px;">python</a><a href="/tags/reading/" style="font-size: 20.00px;">reading</a><a href="/tags/reflect,-blog/" style="font-size: 10.00px;">reflect, blog</a><a href="/tags/storm,-job/" style="font-size: 20.00px;">storm, job</a><a href="/tags/struct/" style="font-size: 10.00px;">struct</a><a href="/tags/summary/" style="font-size: 20.00px;">summary</a><a href="/tags/tomcat/" style="font-size: 10.00px;">tomcat</a><a href="/tags/用户体验,-Sort,-Search/" style="font-size: 10.00px;">用户体验, Sort, Search</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">粉转路人由</h3>
<ul class="entry">
<li><a href="http://letiantian.me" title="樂天笔记~ | 享受生活&&技术&&编程">樂天好男人</a></li>
<li><a href="http://www.urbem.org" title="西城">西城冷风吹</a></li>
<li><a href="http://huangtuzhi.github.io" title="莹莹青碧">逍遥黄岛主</a></li>
<li><a href="http://ccloveyou.org" title="Love life & love tech">浪中云CC</a></li>
<li><a href="http://sinb.github.io" title="Amnesia's blog" >是小司不是小四</a></li>
</ul>
</div>

  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=9&isTitle=0&noborder=0&isWeibo=1&isFans=0&uid=1706116915&verifier=f6d88333&dpc=1"></iframe>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Kangkona D.Han
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>

<a href="https://github.com/kangkona"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/121cd7cbdc3e4855075ea8b558508b91ac463ac2/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png"></a>