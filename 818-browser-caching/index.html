<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    八一八浏览器缓存 // Grey Times
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">

  <meta property="og:title" content="八一八浏览器缓存" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://kangkona.github.io/818-browser-caching/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://kangkona.github.io//css/redlounge.css">
  
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://kangkona.github.io/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="http://kangkona.github.io/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Grey Times" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
 <aside>
 <div>
    

    <a href="http://kangkona.github.io/">
    
    <h1 class="brand-title">Grey Times</h1>
    </a>
    
    <h2 class="brand-tagline">Thoughts in the mirror.</h2>
</div>
</aside>
  <div class="imgctrl">
      <div>
        <img src="http://kangkona.github.io/avatar.png" />
      </div>  
  </div>  
  <div>
  <br/>
  <br/>
  <ul class="drawer">
  <li>
    <a href="#">
      <i class="fa fa-info-circle"></i>
      <span>Info</span>
    </a>
    <ul>
      <li>
        <a href="#" target="_self">
          <i class="fa fa-home"></i>
          <span>Home</span>
        </a>
      </li>
      <li>
        <a href="http://kangkona.github.io//about/" target="_self">
          <i class="fa fa-meh-o"></i>
          <span>About</span>
        </a>
      </li>
      <li>
        <a href="http://kangkona.github.io//contact/" target="_self">
          <i class="fa fa-phone-square"></i>
          <span>Contact</span>
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#">
      <i class="fa fa-folder"></i>
      <span>Project</span>
    </a>
    <ul>
      <li>
        <a href="http://github.com/kangkona/ProPro" target="_blank">
          <i class="fa fa-flash"></i>
          <span>ProPro</span>
        </a>
      </li>
      <li>
        <a href="http://github.com/kangkona/TigerCompiler" target="_blank">
          <i class="fa fa-ellipsis-h"></i>
          <span>Tiger</span>
        </a>
      </li>
      <li>
        <a href="http://github.com/kangkona/frank/" target="_blank">
          <i class="fa fa-dot-circle-o"></i>
          <span>Frank</span>
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#">
      <i class="fa fa-share-alt"></i>
      <span>Social</span>
    </a>
    <ul>
      <li>
        <a href="http://weibo.com/kangkona/" target="_blank">
          <i class="fa fa-weibo"></i>
          <span>Weibo</span>
        </a>
      </li>
      <li>
        <a href="http://github.com/kangkona/" target="_blank">
          <i class="fa fa-github"></i>
          <span>GitHub</span>
        </a>
      </li>
      <li>
        <a href="https://twitter.com/kangkona/" target="_blank">
          <i class="fa fa-twitter"></i>
          <span>twitter</span>
        </a>
      </li>
    </ul>
  </li>

  <li>
    <a href="#">
      <i class="fa fa-external-link"></i>
      <span>Link</span>
    </a>
    <ul>
      <li>
        <a href="http://letiantian.me/" target="_blank">
          <i class="fa fa-smile-o"></i>
          <span>楽</span>
        </a>
      </li>
      <li>
        <a href="http://sinb.github.io" target="_blank">
          <i class="fa fa-music"></i>
          <span>司</span>
        </a>
      </li>
      <li>
        <a href="http://fuzhii.com/" target="_blank">
          <i class="fa fa-book"></i>
          <span>兔</span>
        </a>
      </li>
      <li>
        <a href="http://urbem.github.io/" target="_blank">
          <i class="fa fa-plane"></i>
          <span>航</span>
        </a>
      </li>
      <li>
        <a href="http://beyondcc.github.io/" target="_blank">
          <i class="fa fa-cc"></i>
          <span>诚</span>
        </a>
      </li>
      <li>
        <a href="http://blog.lastww.com/" target="_blank">
          <i class="fa fa-power-off"></i>
          <span>威</span>
        </a>
      </li>
    </ul>
  </li>

    <li>
      <a href="http://kangkona.github.io//gossip/" target="_self">
      <i class="fa fa-microphone"></i>
      <span>Gossip</span>
      </a>
  </li>

</ul>
  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		


  		<section class="post">
            <h1 class="post-title">
              <a href="http://kangkona.github.io/818-browser-caching">八一八浏览器缓存</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>10</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Sep</span> <span class="post-date-year">2014</span>
            	</span>
            	
            
            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-web" href="http://kangkona.github.io//categories/web">Web</a>
				
				</div>
			

			

			

            

<p>今天由于需求变更，修改了部分前端代码，测试没问题之后进行了部署。交付测试时，发现修改的代码不起作用。而且比较奇怪的是一般手机浏览器没有问题，但微信内嵌浏览器内的结果还停留在部署之前的状态。分析后得知应该是缓存机制引起的。这里总结一下关于浏览器缓存的知识。</p>

<h2 id="1-为什么需要浏览器缓存">1. 为什么需要浏览器缓存</h2>

<p>网络的带宽总是有限的，尤其是在并发比较高的情况下，能节约一点儿是一点儿。对于大多数网站来说，类似js, css，图片等静态文件是很少变化的。我们便可以在用户的一次请求之后在本地缓存静态文件。用户进行同样的请求(url一致)时，相应文件直接在本地读取，快速获得响应。 除了减少服务器压力和带宽外，缓存机制还可以极大提高页面的显示速度。</p>

<h2 id="2-缓存协商">2.  缓存协商</h2>

<p>缓存的文件是由服务器生成，在本地保存， 但不是保存下来就万事大吉， 合理使用缓存需要双方动态沟通，这样就引入了缓存协商。下面是具体的请求过程分析：</p>

<pre><code>   (1) 当浏览器第一次请求某个URL时，顺利访问的话，服务器返回状态200的状态, ; 同时会返回给浏览器一些Headers集合，
    如果只设定了Last-Modified和Etag头信息，那么浏览器接收到服务器这些信息后，就会将资源缓存在本地目录中,同时
    保存文件的上述信息.
   (2) 再次请求时，根据 HTTP 协议的规定，浏览器会向服务器传送 If-Modified-Since 与 If-None-Match 报头，这
    两个报头实际上是第一次请求时服务器返回的Last-Modified,Etag。发送这两个报头目地是询问服务器，该资源在
    时间内有没有被修改过。如 果该资源未被修改，则服务器会直接返回HTTP 304 （Not Changed.）状态码，内容为
    空，此时不会下载资源，浏览器则自动从缓存目录中读取资源。
   (3) 只使用Last-Modified和Etag 可以减少传输成本，但不会减少http请求数量。如果给文件加上关于过期时间(Expires)
    的header报文,这样浏览器就会先检查缓存中的文件，如果没有过期，就直接使用缓存中的文件,从而不会 发送http请求。 
</code></pre>

<h2 id="3-缓存存在的问题">3. 缓存存在的问题</h2>

<pre><code>   既然存在了本地，那么最大的问题就是一旦服务器的文件更新了，而浏览器还在使用本地的缓存，
   会造成服务器端的修改不能生效。 我们碰到的问题刚好可以对号入座。
</code></pre>

<h2 id="4-解决之道">4. 解决之道</h2>

<h3 id="4-1-设置html的缓存相关信息">4.1  设置html的缓存相关信息</h3>

<p>在html的头部加入如下信息:</p>

<pre><code>         &lt;META HTTP-EQUIV=&quot;pragma&quot; CONTENT=&quot;no-cache&quot;&gt; 

        &lt;META HTTP-EQUIV=&quot;Cache-Control&quot; CONTENT=&quot;no-cache, must-revalidate&quot;&gt; 

        &lt;META HTTP-EQUIV=&quot;expires&quot; CONTENT=&quot;0&quot;&gt; 
</code></pre>

<p>如果是动态语言生成的页面可以类似设置：</p>

<pre><code>        &lt;% 
        // 将过期日期设置为一个过去时间 
        response.setHeader(&quot;Expires&quot;, &quot;Sat, 6 May 1995 12:00:00 GMT&quot;); 
        // 设置 HTTP/1.1 no-cache 头 
        response.setHeader(&quot;Cache-Control&quot;, &quot;no-store,no-cache,must-revalidate&quot;); 
        // 设置 IE 扩展 HTTP/1.1 no-cache headers， 用户自己添加 
        response.addHeader(&quot;Cache-Control&quot;, &quot;post-check=0, pre-check=0&quot;); 
        // 设置标准 HTTP/1.0 no-cache header. 
        response.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;); 
        %&gt; 
</code></pre>

<h3 id="4-2-使用post代替get">4.2 使用POST代替GET</h3>

<p>根据 HTTP 规范，GET 用于信息获取，是幂等操作。也就是说，当使用相同的URL重复GET请求会返回预期的相同结果时，GET方法才是适用的。当对一个请求有副作用的时候（例如，提交数据注册新用户时），应该使用POST请求而不是GET。 所以浏览器会对GET请求做缓存处理。 不会对POST做缓存。</p>

<h3 id="4-3-在url后加随机参数">4.3 在url后加随机参数</h3>

<p>在一次请求的URL后加随机数，服务器就会认为是不同的请求，就会传回最新的文件覆盖旧的文件。但这种方法仅限于动态语言。</p>

<pre><code>    &lt;%@ page import=&quot;java.util.Random&quot;%&gt;
    &lt;html&gt;  
    &lt;head&gt;
        &lt;script src=&quot;js/fuck.js?&lt;%=new Random().nextInt(1000);%&gt;&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    ...
    &lt;/html&gt;
</code></pre>

<h3 id="4-4-给修改后的文件换个名字">4.4  给修改后的文件换个名字</h3>

<p>上面的三种方法都是完全舍弃缓存优点的做法，如果既想使修改生效，又想继续使用缓存机制应该怎么办呢？  其实最简单的做法就是将修改过的文件换个名称，比如加个时间戳之类的东西。这是的文件就变成了新鲜出炉的文件，本地压根儿就没有，只得乖乖从服务器端获取。<br />
这种方法理论上是行的通的，有时间我会试试，可惜我没有时间了。 你有时间不妨一试？</p>

<p>参考:<br />
<a href="http://alicsd.iteye.com/blog/814276">浅谈浏览器缓存</a><br />
<a href="http://java-xp.iteye.com/blog/1518510">浏览器缓存url请求</a><br />
<a href="http://www.360doc.com/content/10/0826/18/2905268_48986231.shtml">浏览器缓存</a><br />
<a href="http://baike.baidu.com/view/1246381.htm?fr=aladdin">百科</a></p>

	
			

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-frontend" href="http://kangkona.github.io//tags/frontend">frontend</a>,
	                
	                <a class="post-tag post-tag-caching" href="http://kangkona.github.io//tags/caching">caching</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="http://kangkona.github.io/the-story-of-aaron-swartz">互联网之子:亚伦·斯沃茨的故事</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="http://kangkona.github.io/the-meaning-of-blogging">写博客的意义</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	<div id="disqus_thread"></div>
<script type="text/javascript">
     
    var disqus_shortname = 'kangkona';
    
     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>

	<p>Kangkona D.Han &copy; 2015. All rights reserved. </p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>